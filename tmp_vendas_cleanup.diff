*** Begin Patch
*** Update File: c:\Users\Admin\Desktop\multicell-system\src\pages\Vendas.jsx
@@
-    if (!produtoAtual) {
-      setMensagem({
-        tipo: "erro",
-        texto: "Selecione um produto para adicionar ao carrinho.",
-      });
-      return;
-    }
-
-    const produto = produtos.find((p) => p.id === produtoAtual);
-    if (!produto) {
-      setMensagem({ tipo: "erro", texto: "Produto inválido." });
-      return;
-    }
-
-    const quantidade = Number(quantidadeAtual);
-    if (!Number.isFinite(quantidade) || quantidade <= 0) {
-      setMensagem({ tipo: "erro", texto: "Informe uma quantidade válida." });
-      return;
-    }
-
-    const estoqueDisponivel = Number(
-      produto.quantidade_estoque ?? produto.quantidade ?? 0
-    );
-
-    const itemExistente = itens.find((item) => item.produto_id === produto.id);
-    const totalSolicitado = quantidade + (itemExistente?.quantidade || 0);
-    if (totalSolicitado > estoqueDisponivel) {
-      setMensagem({
-        tipo: "erro",
-        texto: `Quantidade solicitada (${totalSolicitado}) maior que estoque disponível (${estoqueDisponivel}).`,
-      });
-      return;
-    }
-
-    const precoUnitario = Number(produto.preco_venda) || 0;
-    const subtotal = Number((precoUnitario * quantidade).toFixed(2));
-
-    setItens((prev) => {
-      const existente = prev.find((item) => item.produto_id === produto.id);
-      if (existente) {
-        return prev.map((item) =>
-          item.produto_id === produto.id
-            ? {
-                ...item,
-                quantidade: item.quantidade + quantidade,
-                subtotal: Number(
-                  (
-                    (item.quantidade + quantidade) *
-                    item.preco_unitario
-                  ).toFixed(2)
-                ),
-              }
-            : item
-        );
-      }
-      return [
-        ...prev,
-        {
-          produto_id: produto.id,
-          nome: produto.nome,
-          quantidade,
-          preco_unitario: precoUnitario,
-          subtotal,
-        },
-      ];
-    });
-
-    setProdutoAtual("");
-    setQuantidadeAtual(1);
-    setMensagem({ tipo: "", texto: "" });
-  }
-
-  function handleRemoverItem(produtoId) {
-    setItens((prev) => prev.filter((item) => item.produto_id !== produtoId));
-  }
-
-  async function finalizarVenda() {
-    if (!proprietarioId) {
-      setMensagem({
-        tipo: "erro",
-        texto: "Sessão expirada. Faça login novamente.",
-      });
-      return;
-    }
-
-    if (!clienteSelecionado) {
-      setMensagem({
-        tipo: "erro",
-        texto: "Selecione um cliente para concluir a venda.",
-      });
-      return;
-    }
-
-    if (!itens.length) {
-      setMensagem({
-        tipo: "erro",
-        texto: "Adicione pelo menos um item antes de finalizar.",
-      });
-      return;
-    }
-
-    setSalvando(true);
-    setMensagem({ tipo: "", texto: "" });
-
-    const payloadVenda = {
-      cliente_id: clienteSelecionado,
-      forma_pagamento: formaPagamento,
-      observacoes: observacoes.trim() || null,
-      total_bruto: Number(totalBruto.toFixed(2)),
-      desconto: Number(descontoNumero.toFixed(2)),
-      total_liquido: Number(totalLiquido.toFixed(2)),
-      proprietario_id: proprietarioId,
-      loja_id: proprietarioId,
-      status: "concluido",
-      data_venda: new Date().toISOString(),
-    };
-
-    try {
-      const { data: venda, error: vendaErro } = await supabase
-        .from("vendas")
-        .insert(payloadVenda)
-        .select()
-        .single();
-
-      if (vendaErro) {
-        throw vendaErro;
-      }
-
-      const itensPayload = itens.map((item) => ({
-        venda_id: venda.id,
-        produto_id: item.produto_id,
-        descricao: item.nome,
-        quantidade: item.quantidade,
-        preco_unitario: item.preco_unitario,
-        subtotal: item.subtotal,
-      }));
-
-      const { error: itensErro } = await supabase
-        .from("itens_venda")
-        .insert(itensPayload);
-
-      if (itensErro) {
-        await supabase.from("vendas").delete().eq("id", venda.id);
-        throw itensErro;
-      }
-
-      await atualizarEstoque(itens);
-
-      setMensagem({ tipo: "sucesso", texto: "Venda registrada com sucesso!" });
-      resetarFormulario();
-      carregarDadosBase();
-    } catch (error) {
-      console.error("[Vendas] Falha ao finalizar venda", error);
-      setMensagem({
-        tipo: "erro",
-        texto: error.message || "Não foi possível concluir a venda.",
-      });
-    } finally {
-      setSalvando(false);
-    }
-  }
-
-  async function atualizarEstoque(itensVenda) {
-    const updates = itensVenda.map((item) => {
-      const produtoReferencia =
-        produtos.find((p) => p.id === item.produto_id) || {};
-      const possuiQuantidade = Object.prototype.hasOwnProperty.call(
-        produtoReferencia,
-        "quantidade"
-      );
-      const estoqueAtual = Number(
-        produtoReferencia.quantidade_estoque ??
-          produtoReferencia.quantidade ??
-          0
-      );
-      const novoEstoque = Math.max(0, estoqueAtual - item.quantidade);
-      const payload = {
-        quantidade_estoque: novoEstoque,
-        atualizado_em: new Date().toISOString(),
-      };
-      if (possuiQuantidade) {
-        payload.quantidade = novoEstoque;
-      }
-      return supabase
-        .from("produtos")
-        .update(payload)
-        .eq("id", item.produto_id);
-    });
-
-    await Promise.all(updates);
-  }
-
-  function resetarFormulario() {
-    setClienteSelecionado("");
-    setFormaPagamento("pix");
-    setObservacoes("");
-    setProdutoAtual("");
-    setQuantidadeAtual(1);
-    setItens([]);
-    setDesconto("0");
-  }
-
-  if (loading) {
-    return (
-      <div className="rounded-xl border border-gray-100 bg-white p-6 text-sm text-gray-600">
-        Carregando sessão...
-      </div>
-    );
-  }
-
-  if (!proprietarioId) {
-    return (
-      <div className="rounded-xl border border-gray-100 bg-white p-6 text-sm text-gray-600">
-        Faça login para registrar vendas na sua loja.
-      </div>
-    );
-  }
-
-  return (
-    <div className="space-y-6">
-      <header>
-        <p className="text-sm uppercase tracking-[0.4em] text-gray-500">
-          Operações
-        </p>
-        <h1 className="text-3xl font-bold text-gray-900">Tela de Vendas</h1>
-        <p className="text-gray-500">
-          Registre vendas completas com itens, estoque automático e métricas
-          consistentes no Supabase.
-        </p>
-      </header>
-
-      <section className="space-y-4 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
-        <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
-          <div>
-            <h2 className="text-lg font-semibold text-gray-900">
-              Insights rápidos
-            </h2>
-            <p className="text-sm text-gray-500">
-              Baseado nos relatórios consolidados (RPCs e consultas
-              centralizadas).
-            </p>
-          </div>
-          <button
-            type="button"
-            className="inline-flex items-center justify-center gap-2 rounded-full border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-600 hover:text-gray-900"
-            onClick={carregarInsights}
-            disabled={insightsCarregando}
-          >
-            {insightsCarregando ? (
-              <>
-                <Loader2 className="h-4 w-4 animate-spin" /> Atualizando...
-              </>
-            ) : (
-              "Atualizar insights"
-            )}
-          </button>
-        </div>
-
-        {erroInsights && (
-          <div className="rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
-            {erroInsights}
-          </div>
-        )}
-
-        <div className="grid gap-4 md:grid-cols-3">
-          <div className="rounded-xl border border-gray-100 bg-slate-50 p-4">
-            <p className="text-xs font-semibold uppercase tracking-widest text-gray-500">
-              Faturamento líquido (mês)
-            </p>
-            <p className="mt-2 text-2xl font-bold text-gray-900">
-              {currency.format(resumoMensal?.totalLiquido || 0)}
-            </p>
-          </div>
-          <div className="rounded-xl border border-gray-100 bg-slate-50 p-4">
-            <p className="text-xs font-semibold uppercase tracking-widest text-gray-500">
-              Ticket médio
-            </p>
-            <p className="mt-2 text-2xl font-bold text-gray-900">
-              {currency.format(resumoMensal?.ticketMedio || 0)}
-            </p>
-          </div>
-          <div className="rounded-xl border border-gray-100 bg-slate-50 p-4">
-            <p className="text-xs font-semibold uppercase tracking-widest text-gray-500">
-              Vendas no período
-            </p>
-            <p className="mt-2 text-2xl font-bold text-gray-900">
-              {resumoMensal?.quantidade || 0}
-            </p>
-          </div>
-        </div>
-
-        <div>
-          <div className="flex items-center justify-between">
-            <h3 className="text-sm font-semibold text-gray-700">
-              Últimas vendas registradas
-            </h3>
-            <span className="text-xs text-gray-500">
-              Janela dos últimos 7 dias
-            </span>
-          </div>
-          {insightsCarregando && !vendasRecentes.length ? (
-            <p className="mt-3 text-sm text-gray-500">Sincronizando...</p>
-          ) : vendasRecentes.length ? (
-            <ul className="mt-4 space-y-3">
-              {vendasRecentes.slice(0, 4).map((venda) => (
-                <li
-                  key={venda.id}
-                  className="flex items-center justify-between rounded-lg border border-gray-100 px-3 py-2 text-sm"
-                >
-                  <div>
-                    <p className="font-semibold text-gray-900">
-                      {venda.cliente?.nome || "Cliente não informado"}
-                    </p>
-                    <p className="text-xs text-gray-500">
-                      {venda.data_venda
-                        ? dateTimeFormatter.format(new Date(venda.data_venda))
-                        : "--"}
-                    </p>
-                  </div>
-                  <div className="text-right">
-                    <p className="font-semibold text-gray-900">
-                      {currency.format(venda.total_liquido)}
-                    </p>
-                    <p className="text-xs capitalize text-gray-500">
-                      {venda.forma_pagamento || "--"}
-                    </p>
-                  </div>
-                </li>
-              ))}
-            </ul>
-          ) : (
-            <p className="mt-3 text-sm text-gray-500">
-              Nenhuma venda registrada nos últimos dias.
-            </p>
-          )}
-        </div>
-      </section>
-
-      {mensagem.texto && (
-        <div
-          className={`rounded-lg border px-4 py-3 text-sm ${
-            mensagem.tipo === "erro"
-              ? "border-red-200 bg-red-50 text-red-700"
-              : "border-emerald-200 bg-emerald-50 text-emerald-700"
-          }`}
-        >
-          {mensagem.texto}
-        </div>
-      )}
-
-      <section className="grid gap-6 lg:grid-cols-3">
-        <div className="space-y-6 lg:col-span-2">
-          <div className="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
-            <h2 className="text-lg font-semibold text-gray-900 mb-4">
-              Dados da venda
-            </h2>
-            <div className="grid gap-4 md:grid-cols-2">
-              <div className="space-y-2">
-                <label className="text-sm font-medium text-gray-600">
-                  Cliente
-                </label>
-                <input
-                  className="input"
-                  placeholder="Buscar cliente"
-                  value={buscaCliente}
-                  onChange={(event) => setBuscaCliente(event.target.value)}
-                  disabled={carregandoDados}
-                />
-                <select
-                  className="input"
-                  value={clienteSelecionado}
-                  onChange={(event) =>
-                    setClienteSelecionado(event.target.value)
-                  }
-                  disabled={carregandoDados}
-                >
-                  <option value="">Selecione o cliente</option>
-                  {clientesFiltrados.map((cliente) => (
-                    <option key={cliente.id} value={cliente.id}>
-                      {cliente.nome}
-                    </option>
-                  ))}
-                </select>
-              </div>
-
-              <div className="space-y-2">
-                <label className="text-sm font-medium text-gray-600">
-                  Forma de pagamento
-                </label>
-                <select
-                  className="input"
-                  value={formaPagamento}
-                  onChange={(event) => setFormaPagamento(event.target.value)}
-                >
-                  {FORMAS_PAGAMENTO.map((forma) => (
-                    <option key={forma.value} value={forma.value}>
-                      {forma.label}
-                    </option>
-                  ))}
-                </select>
-              </div>
-
-              <div className="md:col-span-2 space-y-2">
-                <label className="text-sm font-medium text-gray-600">
-                  Observações
-                </label>
-                <textarea
-                  className="input"
-                  rows={3}
-                  placeholder="Garantia, condição especial..."
-                  value={observacoes}
-                  onChange={(event) => setObservacoes(event.target.value)}
-                />
-              </div>
-            </div>
-          </div>
-
-          <div className="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
-            <div className="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
-              <div className="flex-1 space-y-2">
-                <label className="text-sm font-medium text-gray-600">
-                  Produto
-                </label>
-                <input
-                  className="input"
-                  placeholder="Buscar produto"
-                  value={buscaProduto}
-                  onChange={(event) => setBuscaProduto(event.target.value)}
-                  disabled={carregandoDados}
-                />
-                <select
-                  className="input"
-                  value={produtoAtual}
-                  onChange={(event) => setProdutoAtual(event.target.value)}
-                  disabled={carregandoDados}
-                >
-                  <option value="">Selecione o produto</option>
-                  {produtosFiltrados.map((produto) => {
-                    const estoque = Number(
-                      produto.quantidade_estoque ?? produto.quantidade ?? 0
-                    );
-                    return (
-                      <option key={produto.id} value={produto.id}>
-                        {produto.nome} •{" "}
-                        {currency.format(produto.preco_venda || 0)}
-                        {` • estoque: ${estoque}`}
-                      </option>
-                    );
-                  })}
-                </select>
-              </div>
-
-              <div className="w-full lg:w-40 space-y-2">
-                <label className="text-sm font-medium text-gray-600">
-                  Quantidade
-                </label>
-                <input
-                  className="input"
-                  type="number"
-                  min="1"
-                  value={quantidadeAtual}
-                  onChange={(event) => setQuantidadeAtual(event.target.value)}
-                />
-              </div>
-
-              <button
-                type="button"
-                className="btn btn-primary flex items-center gap-2"
-                onClick={handleAdicionarItem}
-                disabled={carregandoDados}
-              >
-                <PlusCircle size={18} /> Adicionar item
-              </button>
-            </div>
-
-            <div className="mt-6 overflow-x-auto">
-              <table className="w-full text-sm text-gray-700">
-                <thead>
-                  <tr className="text-left text-xs uppercase tracking-wide text-gray-400">
-                    <th className="pb-2">Produto</th>
-                    <th className="pb-2">Qtd.</th>
-                    <th className="pb-2">Preço unit.</th>
-                    <th className="pb-2">Subtotal</th>
-                    <th />
-                  </tr>
-                </thead>
-                <tbody className="divide-y divide-gray-100">
-                  {itens.map((item) => (
-                    <tr key={item.produto_id}>
-                      <td className="py-2 font-semibold text-gray-900">
-                        {item.nome}
-                      </td>
-                      <td className="py-2">{item.quantidade}</td>
-                      <td className="py-2">
-                        {currency.format(item.preco_unitario)}
-                      </td>
-                      <td className="py-2 font-semibold">
-                        {currency.format(item.subtotal)}
-                      </td>
-                      <td className="py-2 text-right">
-                        <button
-                          type="button"
-                          className="inline-flex items-center gap-1 text-red-600 hover:text-red-700"
-                          onClick={() => handleRemoverItem(item.produto_id)}
-                        >
-                          <Trash2 size={14} /> Remover
-                        </button>
-                      </td>
-                    </tr>
-                  ))}
-                </tbody>
-              </table>
-
-              {!itens.length && (
-                <p className="mt-4 text-sm text-gray-500">
-                  Nenhum item adicionado ainda. Selecione um produto e clique em
-                  “Adicionar item”.
-                </p>
-              )}
-            </div>
-          </div>
-        </div>
-
-        <aside className="space-y-4">
-          <div className="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm space-y-4">
-            <div>
-              <p className="text-sm text-gray-500">Total bruto</p>
-              <p className="text-2xl font-bold text-gray-900">
-                {currency.format(totalBruto)}
-              </p>
-            </div>
-
-            <div className="space-y-2">
-              <label className="text-sm font-medium text-gray-600">
-                Desconto
-              </label>
-              <input
-                className="input"
-                type="number"
-                min="0"
-                step="0.01"
-                value={desconto}
-                onChange={(event) => setDesconto(event.target.value)}
-              />
-            </div>
-
-            <div>
-              <p className="text-sm text-gray-500">Total líquido</p>
-              <p className="text-3xl font-bold text-emerald-600">
-                {currency.format(totalLiquido)}
-              </p>
-            </div>
-          </div>
-
-          <button
-            type="button"
-            className="btn btn-primary w-full py-4 text-base flex items-center justify-center gap-2"
-            onClick={finalizarVenda}
-            disabled={salvando || carregandoDados}
-          >
-            {salvando ? (
-              <>
-                <Loader2 className="h-5 w-5 animate-spin" /> Salvando...
-              </>
-            ) : (
-              "Finalizar venda"
-            )}
-          </button>
-        </aside>
-      </section>
-    </div>
-  );
-}
*** End Patch
